--- PortalTravelAgent.java
+++ PortalTravelAgent.java
@@ -299,49 +422,49 @@
         double d4;
 
         for (i2 = i - b0; i2 <= i + b0; ++i2) {
-            d1 = (double) i2 + 0.5D - entity.locX;
+            d1 = (double) i2 + 0.5D - x; // CraftBukkit
 
             for (j2 = k - b0; j2 <= k + b0; ++j2) {
-                d2 = (double) j2 + 0.5D - entity.locZ;
+                d2 = (double) j2 + 0.5D - z; // CraftBukkit
 
                 label271:
                 for (k2 = this.a.V() - 1; k2 >= 0; --k2) {
-                    if (this.a.isEmpty(blockposition_mutableblockposition.setValues(i2, k2, j2))) {
-                        while (k2 > 0 && this.a.isEmpty(blockposition_mutableblockposition.setValues(i2, k2 - 1, j2))) {
+                    if (this.a.isEmpty(blockposition_mutableblockposition.c(i2, k2, j2))) {
+                        while (k2 > 0 && this.a.isEmpty(blockposition_mutableblockposition.c(i2, k2 - 1, j2))) {
                             --k2;
                         }
 
-                        for (i3 = l1; i3 < l1 + 4; ++i3) {
-                            l2 = i3 % 2;
-                            j3 = 1 - l2;
-                            if (i3 % 4 >= 2) {
-                                l2 = -l2;
+                        for (l2 = l1; l2 < l1 + 4; ++l2) {
+                            i3 = l2 % 2;
+                            j3 = 1 - i3;
+                            if (l2 % 4 >= 2) {
+                                i3 = -i3;
                                 j3 = -j3;
                             }
 
-                            for (l3 = 0; l3 < 3; ++l3) {
-                                for (i4 = 0; i4 < 4; ++i4) {
-                                    for (k4 = -1; k4 < 4; ++k4) {
-                                        k3 = i2 + (i4 - 1) * l2 + l3 * j3;
-                                        j4 = k2 + k4;
-                                        int l4 = j2 + (i4 - 1) * j3 - l3 * l2;
+                            for (k3 = 0; k3 < 3; ++k3) {
+                                for (l3 = 0; l3 < 4; ++l3) {
+                                    for (i4 = -1; i4 < 4; ++i4) {
+                                        j4 = i2 + (l3 - 1) * i3 + k3 * j3;
+                                        k4 = k2 + i4;
+                                        int l4 = j2 + (l3 - 1) * j3 - k3 * i3;
 
-                                        blockposition_mutableblockposition.setValues(k3, j4, l4);
-                                        if (k4 < 0 && !this.a.getType(blockposition_mutableblockposition).getBlock().getMaterial().isBuildable() || k4 >= 0 && !this.a.isEmpty(blockposition_mutableblockposition)) {
+                                        blockposition_mutableblockposition.c(j4, k4, l4);
+                                        if (i4 < 0 && !this.a.getType(blockposition_mutableblockposition).getBlock().getMaterial().isBuildable() || i4 >= 0 && !this.a.isEmpty(blockposition_mutableblockposition)) {
                                             continue label271;
                                         }
                                     }
                                 }
                             }
 
-                            d3 = (double) k2 + 0.5D - entity.locY;
+                            d3 = (double) k2 + 0.5D - y; // CraftBukkit
                             d4 = d1 * d1 + d3 * d3 + d2 * d2;
                             if (d0 < 0.0D || d4 < d0) {
                                 d0 = d4;
                                 l = i2;
                                 i1 = k2;
                                 j1 = j2;
-                                k1 = i3 % 4;
+                                k1 = l2 % 4;
                             }
                         }
                     }
@@ -351,42 +474,42 @@
 
         if (d0 < 0.0D) {
             for (i2 = i - b0; i2 <= i + b0; ++i2) {
-                d1 = (double) i2 + 0.5D - entity.locX;
+                d1 = (double) i2 + 0.5D - x; // CraftBukkit
 
                 for (j2 = k - b0; j2 <= k + b0; ++j2) {
-                    d2 = (double) j2 + 0.5D - entity.locZ;
+                    d2 = (double) j2 + 0.5D - z; // CraftBukkit
 
                     label219:
                     for (k2 = this.a.V() - 1; k2 >= 0; --k2) {
-                        if (this.a.isEmpty(blockposition_mutableblockposition.setValues(i2, k2, j2))) {
-                            while (k2 > 0 && this.a.isEmpty(blockposition_mutableblockposition.setValues(i2, k2 - 1, j2))) {
+                        if (this.a.isEmpty(blockposition_mutableblockposition.c(i2, k2, j2))) {
+                            while (k2 > 0 && this.a.isEmpty(blockposition_mutableblockposition.c(i2, k2 - 1, j2))) {
                                 --k2;
                             }
 
-                            for (i3 = l1; i3 < l1 + 2; ++i3) {
-                                l2 = i3 % 2;
-                                j3 = 1 - l2;
-
-                                for (l3 = 0; l3 < 4; ++l3) {
-                                    for (i4 = -1; i4 < 4; ++i4) {
-                                        k4 = i2 + (l3 - 1) * l2;
-                                        k3 = k2 + i4;
-                                        j4 = j2 + (l3 - 1) * j3;
-                                        blockposition_mutableblockposition.setValues(k4, k3, j4);
-                                        if (i4 < 0 && !this.a.getType(blockposition_mutableblockposition).getBlock().getMaterial().isBuildable() || i4 >= 0 && !this.a.isEmpty(blockposition_mutableblockposition)) {
+                            for (l2 = l1; l2 < l1 + 2; ++l2) {
+                                i3 = l2 % 2;
+                                j3 = 1 - i3;
+
+                                for (k3 = 0; k3 < 4; ++k3) {
+                                    for (l3 = -1; l3 < 4; ++l3) {
+                                        i4 = i2 + (k3 - 1) * i3;
+                                        j4 = k2 + l3;
+                                        k4 = j2 + (k3 - 1) * j3;
+                                        blockposition_mutableblockposition.c(i4, j4, k4);
+                                        if (l3 < 0 && !this.a.getType(blockposition_mutableblockposition).getBlock().getMaterial().isBuildable() || l3 >= 0 && !this.a.isEmpty(blockposition_mutableblockposition)) {
                                             continue label219;
                                         }
                                     }
                                 }
 
-                                d3 = (double) k2 + 0.5D - entity.locY;
+                                d3 = (double) k2 + 0.5D - y; // CraftBukkit
                                 d4 = d1 * d1 + d3 * d3 + d2 * d2;
                                 if (d0 < 0.0D || d4 < d0) {
                                     d0 = d4;
                                     l = i2;
                                     i1 = k2;
                                     j1 = j2;
-                                    k1 = i3 % 2;
+                                    k1 = l2 % 2;
                                 }
                             }
                         }
